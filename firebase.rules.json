{
  "rules": {
    "users": {
      ".indexOn": ["msuUid"],
      ".read": "
        auth != null && (
          // Instructors and Admins can read everything
          root.child('roles/'+auth.uid+'/instructor').val() === true
          || root.child('roles/'+auth.uid+'/admin').val() === true
        )
      ",

      "$uid": {
        ".read": "
          // Must be signed in
          auth != null
          // Can read your own user record
          && auth.uid === $uid
        ",
        ".write": "
          // Must be signed in
          auth != null
          && (
            // Can write if you're creating your own user record (signing up)
            (!data.exists() && auth.uid === $uid)
            // Can write if you're an admin
            || root.child('roles/'+auth.uid+'/admin').val() === true
          )
        ",

        "msuUid": {
          ".validate": "
            // Field is optional
            !newData.exists()
            // If provided, must be a string
            || (newData.isString() && newData.val().length > 0)
          "
        },
        "fullName": {
          // Field is a required string
          ".validate": "newData.exists() && newData.isString() && newData.val().length > 0"
        },
        "email": {
          // Field is a required string
          ".validate": "newData.exists() && newData.isString() && newData.val().length > 0"
        },
        "github": {
          "login": {
            // Field is a required string
            ".validate": "newData.exists() && newData.isString()"
          },
          "scope": {
            // Field is a required string
            ".validate": "newData.exists() && newData.isString()"
          },
          "token": {
            // Field is a required string
            ".validate": "newData.exists() && newData.isString()"
          },
          "tokenType": {
            // Field is a required string
            ".validate": "newData.exists() && newData.isString()"
          },
          "userId": {
            // Field is a required number
            ".validate": "newData.exists() && newData.isNumber()"
          }
        },
        "$other": {
          // Only the above fields are permitted
          ".validate": false
        }
      }
    },

    "roles": {
      ".read": "
        // Must be signed in
        auth != null
        && (
          // Instructors and Admins can read everything
          root.child('roles/'+auth.uid+'/instructor').val() === true
          || root.child('roles/'+auth.uid+'/admin').val() === true
        )
      ",

      "$uid": {
        ".read": "
          // Must be signed in
          auth != null
          // Can read your own user record
          && auth.uid === $uid
        ",
        ".write": "
          // Must be signed in
          auth != null
          && (
            // Can write if you're creating your own user record (signing up)
            (!data.exists() && auth.uid === $uid)
            // Can write if you're an admin
            || root.child('roles/'+auth.uid+'/admin').val() === true
          )
        ",
        ".validate": "
          (
            // Short-circuit if updating
            data.exists()
            || (
              // Cannot sign up as an instructor or admin
              (!newData.child('instructor').exists() || newData.child('instructor').val() === false)
              && (!newData.child('admin').exists() || newData.child('admin').val() === false)
            )
          )
        ",

        "instructor": {
          // Field is an optional boolean
          ".validate": "newData.isBoolean()"
        },
        "admin": {
          // Field is an optional boolean
          ".validate": "newData.isBoolean()"
        },
        "$other": {
          // Only the above fields are permitted
          ".validate": false
        }
      }
    },

    "lessons": {
      ".read": "
        // Must be signed in
        auth != null
        && (
          // Instructors and Admins can modify everything
          root.child('roles/'+auth.uid+'/instructor').val() === true
          || root.child('roles/'+auth.uid+'/admin').val() === true
        )
      ",
      ".write": "
        // Must be signed in
        auth != null
        && (
          // Instructors and Admins can modify everything
          root.child('roles/'+auth.uid+'/instructor').val() === true
          || root.child('roles/'+auth.uid+'/admin').val() === true
        )
      ",

      "$key": {
        // Only lowercase letters and hyphens allowed
        ".validate": "$key.matches(/^[-a-z]+$/)",

        "createdBy": {
          // Must match a user
          ".validate": "root.child('users').child(newData.val()).exists()"
        },
        "title": {
          // Field is a required string, empty strings are allowed
          ".validate": "newData.exists() && newData.isString()"
        },
        "learningObjectives": {
          "$lokey": {
            "content": {
              // Field is a required string
              ".validate": "newData.exists() && newData.isString() && newData.val().length > 0"
            }
          }
        },
        "content": {
          // Field is a required string, empty strings are allowed
          ".validate": "newData.exists() && newData.isString()"
        },
        "notes": {
          ".validate": "
            // Field is optional
            !newData.exists()
            // If provided, must be a string
            || newData.isString()
          "
        },
        "prereqKeys": {
          "$prereq_key": {
            ".validate": "
              // Must match a lesson
              root.child('lessons').child($prereq_key).exists()
              // Value must be true
              && newData.val() === true
            "
          }
        },

        "$other": {
          // Only the above fields are permitted
          ".validate": false
        }
      }
    },

    "courses": {
      ".read": "
        auth != null &&
        (
          // Instructors and Admins can modify everything
          root.child('roles/'+auth.uid+'/instructor').val() === true
          || root.child('roles/'+auth.uid+'/admin').val() === true
        )
      ",
      ".write": "
        // Must be signed in
        auth != null
        && (
          // Instructors and Admins can modify everything
          root.child('roles/'+auth.uid+'/instructor').val() === true
          || root.child('roles/'+auth.uid+'/admin').val() === true
        )
      ",

      "$key": {
        ".read": "
          // Must be signed in
          auth != null
          // Students must be enrolled in the course
          && data.child('studentKeys').child(auth.uid).val() === true
        ",

        // Only uppercase letters, numbers, and hyphens allowed
        ".validate": "$key.matches(/^[-A-Z0-9]+$/)",

        "createdBy": {
          // Must match a user
          ".validate": "root.child('users').child(newData.val()).exists()"
        },
        "title": {
          // Field is a required string, empty strings are allowed
          ".validate": "newData.exists() && newData.isString()"
        },
        "credits": {
          // Field is a required number, greater than 0
          ".validate": "newData.exists() && newData.isNumber() && newData.val() > 0"
        },
        "syllabus": {
          // Field is a required string, empty strings are allowed
          ".validate": "newData.exists() && newData.isString()"
        },
        "startDate": {
          // Field is a required RFC2822 date string, empty strings are allowed
          ".validate": "newData.exists() && newData.isString()"
        },
        "endDate": {
          // Field is a required RFC2822 date string, empty strings are allowed
          ".validate": "newData.exists() && newData.isString()"
        },
        "lessonKeys": {
          "$lessonkey": {
            ".validate": "
              // Must match a lesson
              root.child('lessons').child($lessonkey).exists()
              // Value must be true
              && newData.val() === true
            "
          }
        },
        "studentKeys": {
          "$studentkey": {
            ".validate": "
              // Must match a user
              root.child('users').child($studentkey).exists()
              // Value must be true
              && newData.val() === true
            "
          }
        },

        "$other": {
          // Only the above fields are permitted
          ".validate": false
        }
      }
    }
  }
}
