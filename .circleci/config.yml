version: 2
jobs:
  build:
    working_directory: ~/chrisvfritz/msu.lansing.codes
    parallelism: 1
    shell: /bin/bash --login
    # CircleCI 2.0 does not support environment variables that refer to each other
    environment:
      NODE_ENV: testing
      TZ: /usr/share/zoneinfo/America/Detroit
      YARN_VERSION: 1.3.2
    # Pre-built images list: https://circleci.com/docs/2.0/circleci-images/
    docker:
    - image: circleci/node:8.9.4-browsers
      command: /sbin/init
    steps:
    # Setup PATH (can't do in environment section because PATH refers to itself)
    - run:
        working_directory: ~/chrisvfritz/msu.lansing.codes
        command: echo -e "export PATH=${PATH}:~/chrisvfritz/msu.lansing.codes/.yarn/bin:~/chrisvfritz/msu.lansing.codes/node_modules/.bin" >> $BASH_ENV
    # The following `checkout` command checks out your code to your working directory
    - checkout
    # Restore the dependency cache
    - restore_cache:
        keys:
        # This branch if available
        - v1-dep-{{ .Branch }}-
        # Default branch if not
        - v1-dep-master-
    # Ensure yarn and various cached directories are in place
    - run: |
        if [[ ! -e ~/.yarn/bin/yarn || $(yarn --version) != "${YARN_VERSION}" ]]; then
          curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version $YARN_VERSION
        fi
    - run: sudo mkdir -p ~/.cache/yarn frontend/node_modules backend/node_modules firebase/node_modules test/node_modules
    - run: sudo chmod -R 777 ~/.cache/yarn frontend/node_modules backend/node_modules firebase/node_modules test/node_modules
    # Install all dependencies (if necessary)
    - run: yarn install --pure-lockfile
    # Save dependency cache
    - save_cache:
        key: v1-dep-{{ .Branch }}-{{ epoch }}
        paths:
        - ~/.yarn
        - ~/.cache/yarn
        - frontend/node_modules
        - backend/node_modules
        - firebase/node_modules
        - test/node_modules
        - ./node_modules
    # Run unit and end-to-end tests
    - run: yarn test-all
    # Deployment
    # Your existing circle.yml file contains deployment steps.
    # The config translation tool does not support translating deployment steps
    # since deployment in CircleCI 2.0 are better handled through workflows.
    # See the documentation for more information https://circleci.com/docs/2.0/workflows/
    # Teardown
    #   If you break your build into multiple jobs with workflows, you will probably want to do the parts of this that are relevant in each
    # Save artifacts
    - store_artifacts:
        path: frontend/test/unit/coverage/lcov-report
        destination: frontend-tests
    - store_artifacts:
        path: test/e2e/reports
        destination: e2e-tests
